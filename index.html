<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kyle's DreamJourney Tweaker</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> 
    <style>
        :root {
            --bg-primary: #1a1a2e; --bg-secondary: #24243e; --bg-tertiary: #1e1e36; --bg-accent: #2a2a4a;
            --text-primary: #e0e0e0; --text-secondary: #b0b0b0; --text-highlight: #9bf6ff; --text-muted: #8c8c8c;
            --border-color: #3a3a5a; --border-accent: #4a4a6a;
            --slider-accent: #6a0dad; --slider-thumb: #6a0dad; --slider-thumb-hover: #800080;
            --button-primary-bg: #6a0dad; --button-primary-hover-bg: #800080;
            --button-secondary-bg: #ffb74d; --button-secondary-text: #1a1a2e; --button-secondary-hover-bg: #ffa726;
            --warning-recommendation-bg: #FFD700; --warning-recommendation-text: #332e00;
            --warning-critical-bg: #ff6b6b; --warning-critical-text: #1a1a2e;
            --alert-bg: #5c2525; --alert-text: #ffcaca; --alert-border: #a84f4f;
            --positive-spin-text: #a6ffcb;
            --tag-positive-bg: #2a5c3d; --tag-positive-border: #38761d; --tag-positive-text: #d9ead3;
            --tag-negative-bg: #702828; --tag-negative-border: #990000; --tag-negative-text: #f4cccc;
            --tag-neutral-bg: #33334f; --tag-neutral-border: #4a4a6a; --tag-neutral-text: #b0b0b0;
            --tag-critical-warning-bg: #ff6b6b; --tag-critical-warning-border: #e06666; --tag-critical-warning-text: #1a1a2e;
            --tooltip-bg: #33334f; --tooltip-text: #e0e0e0; --tooltip-border: #4a4a6a;
        }
        body.light-theme {
            --bg-primary: #f4f7f6; --bg-secondary: #ffffff; --bg-tertiary: #e9ecef; --bg-accent: #e9f5fe;
            --text-primary: #212529; --text-secondary: #495057; --text-highlight: #007bff; --text-muted: #6c757d;
            --border-color: #dee2e6; --border-accent: #ced4da;
            --slider-accent: #581c87; --slider-thumb: #581c87; --slider-thumb-hover: #4a148c;
            --button-primary-bg: #581c87; --button-primary-hover-bg: #4a148c;
            --button-secondary-bg: #fd7e14; --button-secondary-text: #ffffff; --button-secondary-hover-bg: #e8590c;
            --warning-recommendation-bg: #fff3cd; --warning-recommendation-text: #664d03;
            --warning-critical-bg: #f8d7da; --warning-critical-text: #58151c;
            --alert-bg: #f8d7da; --alert-text: #58151c; --alert-border: #f1aeb5;
            --positive-spin-text: #198754; 
            --tag-positive-bg: #d1e7dd; --tag-positive-border: #a3cfbb; --tag-positive-text: #0f5132;
            --tag-negative-bg: #f8d7da; --tag-negative-border: #f1aeb5; --tag-negative-text: #58151c;
            --tag-neutral-bg: #e9ecef; --tag-neutral-border: #ced4da; --tag-neutral-text: #495057;
            --tag-critical-warning-bg: #f8d7da; --tag-critical-warning-border: #f1aeb5; --tag-critical-warning-text: #58151c;
            --tooltip-bg: #e9ecef; --tooltip-text: #212529; --tooltip-border: #ced4da;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; padding: 10px; background-color: var(--bg-primary); color: var(--text-primary); display: flex; flex-direction: column; align-items: center; line-height: 1.6; transition: background-color 0.3s, color 0.3s; }
        .page-wrapper { width: 100%; max-width: 1100px; position: relative; }
        .theme-toggle-button { position: absolute; top: 10px; right: 10px; padding: 8px 12px; background-color: var(--button-primary-bg); color: var(--text-primary); border: 1px solid var(--border-accent); border-radius: 6px; cursor: pointer; z-index: 1000; font-size: 0.85em; transition: background-color 0.2s, color 0.2s; }
        body.light-theme .theme-toggle-button { color: #ffffff; }
        .theme-toggle-button:hover { background-color: var(--button-primary-hover-bg); }
        .main-container { display: flex; flex-direction: row; gap: 30px; width: 100%; background-color: var(--bg-secondary); border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); padding: 25px; border: 1px solid var(--border-color); margin-top: 60px; margin-bottom: 30px; }
        h1 { text-align: center; color: var(--text-highlight); margin-bottom: 10px; font-size: 1.8em; font-weight: 600; }
        .disclaimer-note { text-align: center; color: var(--text-secondary); font-size: 0.85em; font-style: italic; margin-bottom: 25px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .controls-column { flex: 1; min-width: 280px; max-width: 400px; }
        .profile-column { flex: 1.5; min-width: 320px; position: relative; } 
        .controls { display: flex; flex-direction: column; gap: 25px; }
        .control-group { display: flex; flex-direction: column; }
        .control-group .label-line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .main-label { font-weight: 600; font-size: 1.05em; color: var(--text-primary); }
        .qualitative-value { font-weight: normal; font-style: italic; font-size: 0.85em; color: var(--text-secondary); }
        .control-group input[type="range"] { width: 100%; cursor: pointer; background: var(--border-color); border-radius: 5px; height: 8px; -webkit-appearance: none; appearance: none; accent-color: var(--slider-accent); }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--slider-thumb); border-radius: 50%; border: 2px solid var(--bg-primary); cursor: pointer; transition: background-color 0.2s ease; }
        .control-group input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--slider-thumb); border-radius: 50%; border: 2px solid var(--bg-primary); cursor: pointer; transition: background-color 0.2s ease; }
        .control-group input[type="range"]::-webkit-slider-thumb:hover { background: var(--slider-thumb-hover); }
        .control-group input[type="range"]::-moz-range-thumb:hover { background: var(--slider-thumb-hover); }
        .numerical-value-box { padding: 5px 10px; border-radius: 6px; font-size: 0.9em; text-align: center; margin-top: 8px; width: 75px; margin-left: auto; margin-right: auto; transition: background-color 0.3s ease, color 0.3s ease; background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .numerical-value-box.recommendation-warning { background-color: var(--warning-recommendation-bg); color: var(--warning-recommendation-text); }
        .numerical-value-box.critical-warning { color: var(--warning-critical-text); background-color: var(--warning-critical-bg); font-weight: bold; }
        .slider-ends { display: flex; justify-content: space-between; font-size: 0.75em; color: var(--text-muted); margin-top: 5px; }
        .setting-description { font-size: 0.8em; color: var(--text-secondary); margin-top: 6px; line-height: 1.4; text-align: left; }
        .action-buttons button { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s ease; display: block; width: 90%; max-width: 280px; margin: 15px auto 0 auto; background-color: var(--button-primary-bg); color: var(--text-primary); }
        body.light-theme .action-buttons button { color: #ffffff; } 
        .action-buttons button:hover { background-color: var(--button-primary-hover-bg); }
        #toggle-guide-button { margin-top: 10px; }
        #jump-to-troubleshooting-btn { font-weight: 600; margin: 20px auto; display: block; width: fit-content; padding: 8px 15px; background-color: var(--button-secondary-bg); color: var(--button-secondary-text); }
        #jump-to-troubleshooting-btn:hover { background-color: var(--button-secondary-hover-bg); }
        .description-box { padding: 20px; background-color: var(--bg-accent); border: 1px solid var(--border-accent); height: 100%; display: flex; flex-direction: column; border-radius: 12px;}
        .description-box h3 { font-size: 1.25em; margin-bottom: 15px; border-bottom: 1px solid var(--border-accent); padding-bottom: 12px; text-align: center; margin-top: 0; color: var(--text-highlight); }
        #alert-section { padding: 10px 15px; border-radius: 6px; margin-bottom: 15px; background-color: var(--alert-bg); color: var(--alert-text); border: 1px solid var(--alert-border); }
        #alert-section strong { display: block; margin-bottom: 5px; color: var(--alert-text); } 
        #alert-section.hidden { display: none; }
        #alert-text ul { margin: 0; padding-left: 20px; }
        #alert-text li { margin-bottom: 3px; }
        #quick-vibe-check { font-size: 0.95em; text-align: center; margin-bottom: 15px; padding: 12px; border-radius: 6px; line-height: 1.5; background-color: var(--bg-tertiary); color: var(--text-secondary); border-top: 1px solid var(--border-color); padding-top: 15px;} /* Added border-top */
        #quick-vibe-check h3 { font-size: 1.05em; margin-top: 0; margin-bottom: 8px; padding-bottom: 5px; border-bottom-style: dashed; border-bottom-width: 1px; text-align: center; color: var(--text-secondary); border-color: var(--border-color); }
        .vibe-emoji { font-size: 1.4em; display: block; margin-bottom: 5px; }
        .vibe-persona { font-weight: bold; display: block; margin-bottom: 5px; font-size: 1em; color: var(--text-primary); }
        .vibe-outcome { font-style: italic; font-size: 0.9em; color: var(--text-secondary); }
        .profile-section { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); }
        .profile-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .profile-section strong { font-weight: 600; display: block; margin-bottom: 4px; font-size: 1em; color: var(--text-primary); cursor: help; } 
        .profile-section .section-emoji { margin-right: 8px; font-size: 1.05em; }
        .profile-section span { font-size: 0.9em; line-height: 1.5; text-align: left; color: var(--text-secondary); }
        .positive-spin { font-style: italic; display: block; margin-top: 3px; font-size: 0.85em; color: var(--positive-spin-text); }
        #ai-character-trait { text-align: center; margin-bottom: 15px; padding: 12px; border-radius: 8px; background-color: var(--bg-tertiary); }
        #trait-icon { font-size: 2.5em; display: block; margin-bottom: 8px; }
        #trait-tags-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; }
        .trait-tag { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; color: var(--tag-neutral-text); background-color: var(--tag-neutral-bg); border: 1px solid var(--tag-neutral-border); cursor: help; }
        .trait-tag.positive { color: var(--tag-positive-text); background-color: var(--tag-positive-bg); border: 1px solid var(--tag-positive-border); }
        .trait-tag.negative { color: var(--tag-negative-text); background-color: var(--tag-negative-bg); border: 1px solid var(--tag-negative-border); }
        .trait-tag.critical-warning { font-weight: bold; color: var(--tag-critical-warning-text); background-color: var(--tag-critical-warning-bg); border: 1px solid var(--tag-critical-warning-border); }
        
        /* Custom Tooltip Styles */
        .custom-tooltip {
            position: absolute;
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            border: 1px solid var(--tooltip-border);
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.85em;
            line-height: 1.4;
            z-index: 1001; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 250px;
            text-align: left;
            opacity: 0; /* Hidden by default, JS will toggle */
            pointer-events: none; /* Prevent tooltip from interfering with other clicks */
            transition: opacity 0.2s ease-in-out;
        }
        .custom-tooltip.visible {
            opacity: 1;
            pointer-events: auto;
        }


        /* Styles for Rendered Markdown Guide */
        .tips-guide-container { border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); padding: 20px; margin-top: 30px; background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .tips-guide-container.hidden { display: none; }
        #tips-guide-content h1, #tips-guide-content h2, #tips-guide-content h3 { border-bottom: 1px solid var(--border-accent); padding-bottom: 8px; margin-top: 18px; margin-bottom: 12px; color: var(--text-highlight); }
        #tips-guide-content h1 { font-size: 1.5em; text-align: center; } 
        #tips-guide-content h2 { font-size: 1.3em; } 
        #tips-guide-content h3 { font-size: 1.15em; } 
        #tips-guide-content p { margin-bottom: 10px; line-height: 1.65; color: var(--text-primary); }
        #tips-guide-content ul, #tips-guide-content ol { margin-left: 0px; margin-bottom: 12px; padding-left: 22px; }
        #tips-guide-content li { margin-bottom: 6px; }
        #tips-guide-content strong { font-weight: 600; color: var(--text-primary); }
        #tips-guide-content code { padding: 2px 5px; border-radius: 4px; font-size: 0.9em; background-color: var(--bg-tertiary); color: var(--alert-text); }
        #tips-guide-content pre { padding: 15px; border-radius: 6px; overflow-x: auto; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); }
        #tips-guide-content pre code { background-color: transparent; padding: 0; font-size: 0.9em; }
        .troubleshooting-table { width: 100%; border-collapse: collapse !important; margin-top: 20px; margin-bottom: 25px; font-size: 0.9em; border: 1px solid var(--border-accent) !important; }
        .troubleshooting-table th, .troubleshooting-table td { border: 1px solid var(--border-accent) !important; padding: 10px 12px; text-align: left; vertical-align: top; }
        .troubleshooting-table th { font-weight: 600; background-color: var(--tag-neutral-bg) !important; color: var(--text-highlight); }
        .troubleshooting-table tr:nth-child(even) td { background-color: var(--bg-tertiary); }
        .troubleshooting-table td ul { margin: 5px 0 0 0; padding-left: 18px; }
        .troubleshooting-table td ul li { margin-bottom: 4px; }

        @media (max-width: 900px) { .main-container { flex-direction: column; max-width: 700px; } .controls-column, .profile-column { max-width: 100%; } .profile-column { margin-top: 30px; } }
        @media (max-width: 600px) { body { padding: 10px 5px; } .page-wrapper { padding-left: 5px; padding-right: 5px; } .main-container { padding: 15px; gap: 20px; } h1 { font-size: 1.5em; } .main-label { font-size: 1em; } .description-box { padding: 15px; } .description-box h3 { font-size: 1.15em; } .profile-section strong { font-size: 0.95em; } .profile-section span { font-size: 0.85em; } #ai-character-trait { margin-bottom: 15px; padding: 10px; } #trait-icon { font-size: 2.2em; } .trait-tag { font-size: 0.75em; padding: 3px 8px; } .numerical-value-box { width: 65px; font-size: 0.85em; } #quick-vibe-check { font-size: 0.9em; } .tips-guide-container { padding: 15px; } .tips-guide-container h1 { font-size: 1.3em; } .tips-guide-container h2 { font-size: 1.15em; } .tips-guide-container h3 { font-size: 1.05em; } .troubleshooting-table th, .troubleshooting-table td { padding: 6px 8px; font-size: 0.8em; } .action-buttons button { width: 95%; max-width: none; font-size: 0.85em; padding: 8px 10px; } }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="page-wrapper"> 
        <button id="theme-toggle-button" class="theme-toggle-button">Switch Theme üé®</button>
        <h1><span role="img" aria-label="Robot">ü§ñ</span> Kyle's DreamJourney Tweaker <span role="img" aria-label="Robot">ü§ñ</span></h1>
        <p class="disclaimer-note">Some models may vary and settings may have to be tweaked between models. Experiment to find what you like, or even adjust mid roleplay to change up the roleplay a bit!</p>
        
        <div class="main-container">
            <div class="controls-column">
                <div class="controls">
                    <div class="control-group">
                        <div class="label-line">
                            <span class="main-label">Temperature</span>
                            <span id="temp-qualitative-text" class="qualitative-value">Balanced</span>
                        </div>
                        <input type="range" id="temp-slider" min="0.1" max="2.0" step="0.01" value="0.8">
                        <div class="numerical-value-box" id="temp-numerical-container"><span id="temp-numerical-value">0.80</span></div>
                        <div class="slider-ends">
                            <span>Predictable</span> <span>Creative</span>
                        </div>
                        <p class="setting-description">Controls response creativity/randomness. Lower (0.1-0.7) is predictable. Recommended: 0.7-1.2 for balance. Higher (>1.2) is very creative/surprising.</p> 
                    </div>
                    <div class="control-group">
                         <div class="label-line">
                            <span class="main-label">Repetition Penalty</span>
                            <span id="repPen-qualitative-text" class="qualitative-value">Balanced</span>
                        </div>
                        <input type="range" id="repPen-slider" min="1.0" max="2.0" step="0.01" value="1.08">
                        <div class="numerical-value-box" id="repPen-numerical-container"><span id="repPen-numerical-value">1.08</span></div>
                         <div class="slider-ends">
                            <span>Disabled (1.0)</span> 
                            <span>Strongly Avoids (2.0)</span>
                        </div>
                         <p class="setting-description">Discourages repeating words. 1.0 is neutral. Recommended: 1.0-1.4 for balanced control. Higher (>1.7) can degrade quality.</p> 
                    </div>
                    <div class="control-group">
                         <div class="label-line">
                            <span class="main-label">Min P</span>
                            <span id="minP-qualitative-text" class="qualitative-value">Balanced</span>
                        </div>
                        <input type="range" id="minP-slider" min="0.0" max="1.0" step="0.001" value="0.06">
                        <div class="numerical-value-box" id="minP-numerical-container"><span id="minP-numerical-value">0.06</span></div> 
                         <div class="slider-ends">
                            <span>Permissive (0.0)</span>
                            <span>Very Strict (1.0)</span>
                        </div>
                        <p class="setting-description">Filters unlikely words. Higher values are more restrictive. Recommended: 0.04-0.1. Set to 0 to disable.</p>
                    </div>
                </div>
                <div class="action-buttons"> 
                    <button id="reset-button">Reset to Defaults</button>
                    <button id="toggle-guide-button">AI Troubles? Show/Hide Guide</button> 
                </div>
            </div>

            <div class="profile-column">
                <div class="description-box">
                    <h3>Roleplay & Response Profile</h3>
                    <div id="alert-section" class="hidden">
                        <strong>Potential Issue Alert:</strong>
                        <div id="alert-text"></div> 
                    </div>

                    <div id="ai-character-trait"> 
                        <span id="trait-icon" role="img" aria-label="Trait Icon">‚öñÔ∏è</span>
                        <div id="trait-tags-container">
                            {/* Tags injected by JS */}
                        </div>
                    </div>
                    
                    <div id="quick-vibe-check">
                        <h3>Vibe Check:</h3>
                        <span class="vibe-emoji" role="img" aria-label="Vibe Emoji">ü§î</span>
                        <div>
                            <span class="vibe-persona">The Balanced Storyteller...</span>
                            <span class="vibe-outcome">aims for engaging and coherent roleplay.</span>
                        </div>
                    </div>
                                    
                    <div class="profile-section"><strong><span class="section-emoji" role="img" aria-label="Idea Pool">üí°</span> Variance (Idea Pool):</strong> <span id="variance-text">Moderate</span></div>
                    <div class="profile-section"><strong><span class="section-emoji" role="img" aria-label="Focus">üéØ</span> Coherence & Focus (Idea Selection):</strong> <span id="coherence-text">Good</span></div>
                    <div class="profile-section"><strong><span class="section-emoji" role="img" aria-label="Guide">üó∫Ô∏è</span> Prompt Adherence (Following the Scene):</strong> <span id="adherence-text">Balanced</span></div>
                    <div class="profile-section"><strong><span class="section-emoji" role="img" aria-label="Dialogue">üí¨</span> Word Choice & Tone (Dialogue Polish):</strong> <span id="repetition-text">Natural</span></div>
                </div>
            </div>
        </div>
        
        <button id="jump-to-troubleshooting-btn" style="display:none;">Having Issues? Jump to Troubleshooting Tips üëá</button>
        <div id="custom-tooltip" class="custom-tooltip hidden"></div> <div id="tips-guide-container" class="tips-guide-container hidden"> 
            <div id="tips-guide-content"></div> 
        </div>
    </div>

    <script type="text/template" id="markdown-template">
# Kyle's DJ AI Setting Tips & Troubleshooting Guide

Welcome, Dreamjourneyer! Understanding how Temperature, Min P, and Repetition Penalty work together can greatly enhance your AI roleplaying experience. This guide offers some tips and troubleshooting advice using the "AI Chef" analogy. Think of it like tuning an instrument or seasoning a dish ‚Äì small adjustments can make a big difference!

## The Core Settings: The AI Chef Analogy üç≥ü§ñ

Imagine your AI is a creative chef preparing a dish (the response):

* **Temperature: The "Adventure" Dial üî•**
    * **What it is:** Controls how risky or creative the chef is with ingredients (words/ideas).
    * **Low Temp (e.g., 0.1-0.7):** The chef sticks to classic, well-known recipes. The dish is predictable and focused.
    * **Medium Temp (e.g., 0.7-1.2 - Recommended):** The chef is inspired, using reliable recipes but adding a creative twist. Balanced and engaging.
    * **High Temp (e.g., >1.2):** A culinary daredevil! Expect exotic, unexpected ingredients. Could be brilliant or bizarre!

* **Min P: The "Quality Control" Inspector üßê**
    * **What it is:** After the chef (Temperature) brainstorms ingredients, Min P sets a minimum "acceptability" score (probability). Ingredients below this are discarded.
    * **Low Min P (e.g., 0.0-0.04):** Very lenient inspector, most ingredients pass, even if questionable.
    * **Medium Min P (e.g., 0.04-0.1 - Recommended):** Good judgment, discards unsuitable ingredients but allows quality options.
    * **High Min P (e.g., >0.1):** Extremely strict, only "safest" ingredients. Too high, and the chef has nothing to cook with!

* **Repetition Penalty: The "Variety" Rule üîÑ**
    * **What it is:** Tells the chef how much to avoid using the same ingredient/technique repeatedly (1.0 is neutral/disabled).
    * **Disabled/Low (1.0):** Chef doesn't mind reusing favorite ingredients. Dish might have recurring flavors.
    * **Medium (e.g., 1.01-1.4 - Recommended):** Chef varies ingredients to keep the dish interesting.
    * **High (e.g., >1.4):** Chef is *obsessed* with novelty, sometimes using strange substitutes or making the dish taste forced. Too high (>1.7) can lead to unpalatable results.

## General Advice for Your Culinary AI Adventure

* **Start with Defaults:** Use the "Reset to Defaults" button (Temp: 0.8, Min P: 0.06, Rep Pen: 1.08) as a good baseline.
* **One Knob at a Time:** Adjust one setting at a time to clearly see its effect.
* **Small Increments:** Small changes can have big impacts.
* **Context Matters:** "Perfect" settings change with character, scene, or style. Tweak mid-RP!
* **Model Differences:** Remember the disclaimer! Different AI models respond differently. Use this Tweaker as a guide, but trust your experience.

---
<div id="troubleshooting-section-anchor"></div>
Happy Shaping, and may your AI Chef cook up some amazing stories!
    </script>
    <script>
        const tempSlider = document.getElementById('temp-slider');
        const minPSlider = document.getElementById('minP-slider');
        const repPenSlider = document.getElementById('repPen-slider');
        const resetButton = document.getElementById('reset-button');
        const toggleGuideButton = document.getElementById('toggle-guide-button'); 
        const jumpToTroubleshootingButton = document.getElementById('jump-to-troubleshooting-btn');
        const themeToggleButton = document.getElementById('theme-toggle-button');
        const customTooltip = document.getElementById('custom-tooltip');
        
        const tempQualitativeText = document.getElementById('temp-qualitative-text');
        const tempNumericalValue = document.getElementById('temp-numerical-value');
        const tempNumericalContainer = document.getElementById('temp-numerical-container'); 
        
        const minPQualitativeText = document.getElementById('minP-qualitative-text');
        const minPNumericalContainer = document.getElementById('minP-numerical-container');
        const minPNumericalValue = document.getElementById('minP-numerical-value');

        const repPenQualitativeText = document.getElementById('repPen-qualitative-text');
        const repPenNumericalContainer = document.getElementById('repPen-numerical-container');
        const repPenNumericalValue = document.getElementById('repPen-numerical-value');

        const traitIconElement = document.getElementById('trait-icon'); 
        const traitTagsContainerElement = document.getElementById('trait-tags-container');

        const quickVibeCheckElement = document.getElementById('quick-vibe-check'); 

        const alertSection = document.getElementById('alert-section');
        const alertText = document.getElementById('alert-text'); 
        const varianceText = document.getElementById('variance-text');
        const coherenceText = document.getElementById('coherence-text');
        const adherenceText = document.getElementById('adherence-text');
        const repetitionText = document.getElementById('repetition-text');
        
        const guideContainerDiv = document.getElementById('tips-guide-container'); 
        const guideContentDiv = document.getElementById('tips-guide-content'); 

        const tempEffectiveMinPPlotDomain = [0.0, 0.2]; 

        const defaultSettings = {
            temp: 0.8,
            minP: 0.06,
            repPen: 1.08
        };

        const recRanges = {
            temp: { low: 0.7, high: 1.2 },
            minP: { low: 0.04, high: 0.1 },
            repPen: { low: 1.0, high: 1.4 } 
        };

        function applyDefaults() {
            tempSlider.value = defaultSettings.temp;
            minPSlider.value = defaultSettings.minP;
            repPenSlider.value = defaultSettings.repPen;
            updateUI();
        }

        // Tooltip Data Store
        const tooltipData = {
            variance: "Variance describes how different or predictable the AI's ideas and phrasing will be. Temperature is the main driver here.",
            coherence: "Coherence & Focus describe how logical, on-topic, and sensible the AI's responses are. Primarily influenced by Temperature and Min P; extreme Repetition Penalty can also negatively impact it.",
            adherence: "Prompt Adherence describes how closely the AI is expected to follow your specific prompts, instructions, and character concepts. Lower Temperature and moderate-to-high Min P generally increase adherence.",
            repetition: "Word Choice & Tone are primarily affected by Repetition Penalty, which influences how often the AI reuses words and phrases. This impacts the naturalness and variety of its dialogue."
        };


        function updateUI() {
            const temp = parseFloat(tempSlider.value);
            const minP = parseFloat(minPSlider.value);
            const repPen = parseFloat(repPenSlider.value);

            tempNumericalValue.textContent = temp.toFixed(2);
            minPNumericalValue.textContent = minP.toFixed(2); 
            repPenNumericalValue.textContent = repPen.toFixed(2);

            // --- Qualitative Labels & Warnings for Sliders ---
            tempNumericalContainer.classList.remove('recommendation-warning', 'critical-warning'); 
            if (temp < recRanges.temp.low || temp > recRanges.temp.high) {
                tempNumericalContainer.classList.add('recommendation-warning');
            }
            if (temp < 0.4) tempQualitativeText.textContent = "Very Rigid (XLow)"; 
            else if (temp < 0.7) tempQualitativeText.textContent = "Predictable (Low)";
            else if (temp <= 0.9) tempQualitativeText.textContent = "Slightly Predictable (Rec.)";
            else if (temp <= 1.2) tempQualitativeText.textContent = "Balanced (Rec.)";
            else if (temp <= 1.6) tempQualitativeText.textContent = "Creative";
            else tempQualitativeText.textContent = "Very Creative (High)";

            let minPCriticalWarningThreshold = 0.25; 
            if (temp <= 0.5) { minPCriticalWarningThreshold = 0.5; } 
            else if (temp > 0.5 && temp <= 1.2) { minPCriticalWarningThreshold = 0.25; } 
            else { minPCriticalWarningThreshold = 0.15; } 
            
            minPNumericalContainer.classList.remove('recommendation-warning', 'critical-warning');
            if (minP > minPCriticalWarningThreshold || minP > 0.2) {
                 minPNumericalContainer.classList.add('critical-warning');
            } else if (minP < recRanges.minP.low || minP > recRanges.minP.high) {
                minPNumericalContainer.classList.add('recommendation-warning');
            }
            
            if (minP < 0.04) minPQualitativeText.textContent = "Very Permissive (Low)";
            else if (minP <= 0.07) minPQualitativeText.textContent = "Permissive (Rec.)";
            else if (minP <= 0.1) minPQualitativeText.textContent = "Balanced (Rec.)";
            else if (minP <= 0.15) minPQualitativeText.textContent = "Slightly Strict";
            else if (minP <= minPCriticalWarningThreshold && minP <= 0.2) minPQualitativeText.textContent = "Strict"; 
            else minPQualitativeText.textContent = "Very Strict (High)";
            
            const repPenCriticalWarningThreshold = 1.7; 
            repPenNumericalContainer.classList.remove('recommendation-warning', 'critical-warning');
            if (repPen > repPenCriticalWarningThreshold) { 
                repPenNumericalContainer.classList.add('critical-warning');
            } else if (repPen > recRanges.repPen.high) { 
                 if (repPen !== 1.0) { 
                    repPenNumericalContainer.classList.add('recommendation-warning');
                 }
            }

            if (repPen === 1.0) repPenQualitativeText.textContent = "Disabled / Neutral";
            else if (repPen <= 1.15) repPenQualitativeText.textContent = "Balanced Control (Rec.)"; 
            else if (repPen <= 1.4) repPenQualitativeText.textContent = "Reduces Moderately (Rec.)";
            else if (repPen <= repPenCriticalWarningThreshold) repPenQualitativeText.textContent = "Avoids Strongly"; 
            else repPenQualitativeText.textContent = "Extremely Avoidant (High)";

            // --- Enhanced Alert Section ---
            let alertMessages = [];
            let positiveSpins = []; 

            if (temp < 0.3 && minP < 0.02) { 
                alertMessages.push("Very low Temperature + very low Min P: Responses may become extremely dull, repetitive, overly simplistic, or get stuck in short loops. The AI has few ideas and no filter.");
            } else if (temp < 0.5 && minP > 0.3) {
                alertMessages.push("Very low Temperature + high Min P: May result in extremely short, highly repetitive, or even no responses. Creativity is severely stifled.");
                 positiveSpins.push({for:"Very low Temperature + high Min P", text:"Bright Side: If you need an AI that *only* says one specific thing (and almost nothing else), this might be it."});
            } else if (temp < 0.6 && minP > 0.15 && minP > recRanges.minP.high) { 
                 alertMessages.push("Low Temperature + stricter Min P: Can limit creative options and lead to brief, overly focused replies.");
            }

            if (temp > 1.7 && minP < 0.03) {
                alertMessages.push("Extremely high Temperature + very low Min P: Significantly increases the chance of nonsensical, off-topic, or highly chaotic and unpredictable responses.");
                positiveSpins.push({for:"Extremely high Temperature + very low Min P", text:"Creative Use: Perfect for pure chaos, avant-garde poetry, or if you want the AI to generate completely unexpected, boundary-pushing ideas."});
            } else if (temp > 1.5 && minP < 0.05) {
                 alertMessages.push("High Temperature + permissive Min P: Can make responses less focused, more random, and potentially less coherent.");
                 positiveSpins.push({for:"High Temperature + permissive Min P", text:"Creative Use: Good for brainstorming a wide array of ideas, even if some are tangents."});
            }

            if (repPenNumericalContainer.classList.contains('critical-warning')) { 
                 if (repPen > 1.8) { 
                    alertMessages.push("Extremely high Repetition Penalty (>1.8): May make language sound unnatural, robotic, or force the use of very obscure words.");
                    positiveSpins.push({for:"Extremely high Repetition Penalty", text:"Bright Side: You'll almost certainly get unique phrasing for every sentence!"});
                 } else if (repPen > repPenCriticalWarningThreshold) { 
                    alertMessages.push("High Repetition Penalty (>" + repPenCriticalWarningThreshold.toFixed(1) + "): Can degrade response quality, making language feel forced or unnatural.");
                 }
            }
            if (repPen > 1.6 && temp < 0.8) { 
                 alertMessages.push("High Repetition Penalty + low Temperature: Might feel overly restrictive and make it hard for the AI to form natural sentences.");
            }
            if (minPNumericalContainer.classList.contains('critical-warning')) { 
                if (minP > 0.4) { 
                    alertMessages.push("Very high Min P (>0.4): Will severely filter word choices, likely breaking response generation or leading to extremely truncated outputs.");
                } else if (minP > 0.2 && !alertMessages.some(msg => msg.includes("Min P") && msg.includes("Temperature"))) { 
                    alertMessages.push("High Min P (>0.2): Can significantly restrict word choices, potentially impacting natural flow.");
                }
            }

            if (alertMessages.length > 0) {
                const uniqueAlertMessages = [...new Set(alertMessages)];
                let alertHTML = "<ul>";
                uniqueAlertMessages.forEach(msg => {
                    alertHTML += `<li>${msg}</li>`;
                    const spin = positiveSpins.find(s => msg.startsWith(s.for.split(":")[0])); // Match based on start of message
                    if(spin) alertHTML += `<li><em class="positive-spin">${spin.text}</em></li>`;
                });
                alertHTML += "</ul>";
                alertText.innerHTML = alertHTML;
                alertSection.classList.remove('hidden');
            } else {
                alertSection.classList.add('hidden');
            }
            
            // --- AI Character Trait Display ---
            let currentTraitIcon = "‚öñÔ∏è"; 
            let currentTraitTags = [];

            if (alertMessages.length > 0 && !(temp < 0.4 && minP < 0.03)) { 
                currentTraitIcon = "‚ö†Ô∏è";
                currentTraitTags.push({text: "Extreme Settings!", type: "critical-warning", title: "One or more settings are at a level that may cause issues."});
                currentTraitTags.push({text: "See Alerts", type: "critical-warning", title: "Check the 'Potential Issue Alert' box above for details."}); 
            } else {
                // Simplified categories for tags
                let tempTagType = "neutral", tempTagText = "Balanced Temp";
                if (temp > 1.5) {tempTagType = "positive"; tempTagText = "Very Creative"; currentTraitIcon = "üî•";}
                else if (temp > 1.2) {tempTagType = "positive"; tempTagText = "Creative"; currentTraitIcon = "‚ú®";}
                else if (temp < 0.4) {tempTagType = "negative"; tempTagText = "Very Rigid"; currentTraitIcon = "üßä";}
                else if (temp < 0.7) {tempTagType = "neutral"; tempTagText = "Predictable"; currentTraitIcon = "üßê";}
                currentTraitTags.push({text: tempTagText, type: tempTagType, title: `Temperature is ${temp.toFixed(2)}`});

                let minPTagType = "neutral", minPTagText = "Balanced Filter";
                if (minP > 0.3) {minPTagType = "negative"; minPTagText = "Extreme Filter"; if(minP > 0.4) currentTraitIcon = "üöß";}
                else if (minP > 0.15) {minPTagType = "negative"; minPTagText = "Strict Filter";}
                else if (minP < 0.03) {minPTagType = "neutral"; minPTagText = "Loose Filter";}
                currentTraitTags.push({text: minPTagText, type: minPTagType, title: `Min P is ${minP.toFixed(2)}`});
                
                let repPenTagType = "neutral", repPenTagText = "Balanced Rep Control";
                if (repPen > 1.7) {repPenTagType = "negative"; repPenTagText = "Forced Novelty";}
                else if (repPen > 1.4) {repPenTagType = "positive"; repPenTagText = "Varied Phrasing";}
                else if (repPen === 1.0 ) {repPenTagType = "neutral"; repPenTagText = "Allows Repetition";}
                currentTraitTags.push({text: repPenTagText, type: repPenTagType, title: `Rep Pen is ${repPen.toFixed(2)}`});
            }
            traitIconElement.textContent = currentTraitIcon;
            traitTagsContainerElement.innerHTML = currentTraitTags.map(tag => 
                `<span class="trait-tag ${tag.type}" data-tooltip="${tag.title || tag.text}">${tag.text}</span>`
            ).join('');


            // --- Quick Vibe Check (Persona-based) ---
            let vibePersona = "";
            let vibeOutcome = "";
            let vibeEmoji = "ü§î"; 

            if (alertMessages.length > 0) {
                vibeEmoji = "‚ö†Ô∏è"; 
                vibePersona = "The Alchemist of Extremes"; // Changed persona for alert state
                vibeOutcome = "Is brewing a potent mix! Check the alerts above for potential side effects, both wondrous and wild.";
            } else if (temp < 0.4 && minP < 0.03) { 
                 vibePersona = "The Echo Chamber"; vibeOutcome = "Will likely produce very simple, repetitive, or even stuck phrases. Highly predictable, but lacks depth."; vibeEmoji = "üß±";
            } else if (temp < 0.5 && minP > 0.2) { vibePersona = "The Meticulous Accountant"; vibeOutcome = "Calculates every word with extreme prejudice. Expect very short, possibly clipped or no replies."; vibeEmoji = "ü§´";}
            else if (temp > 1.6 && minP < 0.03) { vibePersona = "The Cosmic Joker"; vibeOutcome = "Is throwing out a universe of unpredictable ideas! Expect a chaotic, often nonsensical, but potentially hilarious journey."; vibeEmoji = "ü§™";}
            else if (temp > 1.3 && minP < 0.05) { vibePersona = "The Adventurous Bard"; vibeOutcome = "Loves to explore novel ideas with a relaxed filter. Expect diverse, surprising, and mostly coherent story beats."; vibeEmoji = "üó∫Ô∏è";}
            else if (temp < 0.7 && minP > 0.12) { vibePersona = "The Scholarly Librarian"; vibeOutcome = "Delivers focused, logical, and carefully chosen words. Very controlled and factual in tone."; vibeEmoji = "üßê";}
            
            // More Granular Vibe Personas for less extreme, more common settings
            else if (temp >= 0.7 && temp <= 0.9 && minP >= 0.04 && minP <= 0.1) { vibePersona = "The Methodical Storyteller"; vibeOutcome = "Crafts responses with care, leaning towards consistency but is open to adding some creative sparks."; vibeEmoji = "‚úçÔ∏è";}
            else if (temp > 0.9 && temp <= 1.2 && minP >= 0.04 && minP <= 0.1) { vibePersona = "The Engaging Collaborator"; vibeOutcome = "Aims for a great balance of creativity and coherence. Ideal for most rich and interactive roleplay!"; vibeEmoji = "üëç";}
            else if (temp > 0.9 && temp <= 1.2 && minP < 0.04) { vibePersona = "The Flexible Friend"; vibeOutcome = "Offers balanced creativity with a very open filter, allowing many ideas to flow freely."; vibeEmoji = "üòä";}
             else if (temp > 0.9 && temp <= 1.2 && minP > 0.1 && minP <=0.15) { vibePersona = "The Focused Creator"; vibeOutcome = "Generates creative ideas but keeps them tightly relevant and well-polished for clarity."; vibeEmoji = "üéØ";}
            else { vibePersona = "The Balanced Narrator"; vibeOutcome = "Offers a standard mix of predictability and creativity, generally staying on track."; vibeEmoji = "‚öñÔ∏è";} 
            
            vibeOutcome = vibeOutcome.charAt(0).toUpperCase() + vibeOutcome.slice(1);

            if (alertMessages.length === 0 && repPen > 1.5) {
                 if (repPen > 1.7) vibeOutcome += " Dialogue will be *forced* to be unique, possibly sounding unnatural.";
                 else vibeOutcome += " Dialogue will be actively varied, sometimes sounding a bit formal.";
            } else if (alertMessages.length === 0 && repPen === 1.0 && temp <=1.2) {
                vibeOutcome += " Natural dialogue repetition is likely.";
            }
            
            quickVibeCheckElement.innerHTML = `<h3>Vibe Check:</h3><span class="vibe-emoji" role="img" aria-label="Vibe Emoji">${vibeEmoji}</span><div><span class="vibe-persona">${vibePersona}</span><span class="vibe-outcome">${vibeOutcome}</span></div>`;

            // --- Detailed Profile Sections (More Reactive to Extremes, direct language) ---
            let varianceDesc = ""; 
            // Add data-tooltip here
            varianceText.parentElement.setAttribute('data-tooltip-text', "Variance describes how different or predictable the AI's ideas and phrasing will be. Temperature is the main driver here.");
            if (temp > 1.8) varianceDesc = "<span class='section-emoji'>üí•</span>Off the Charts: Expect extremely random and novel outputs. The AI is basically freestyling. <span class='positive-spin'>Perfect for pure brainstorming or maximum surprise!</span>";
            else if (temp > 1.5) varianceDesc = "<span class='section-emoji'>üî•</span>Very High: Highly diverse and surprising responses. The AI will explore many unusual paths. <span class='positive-spin'>Great for breaking creative ruts. Use if you want the AI to truly shock you.</span>";
            else if (temp > 1.2) varianceDesc = "<span class='section-emoji'>‚ú®</span>High: Responses will often be surprising and different each time. Good for unexpected plot twists or when you want the AI to take more initiative. <span class='positive-spin'>Can spark new directions.</span>";
            else if (temp >= 0.7) varianceDesc = "<span class='section-emoji'>‚öñÔ∏è</span>Moderate: A good mix of consistency and new ideas. Keeps things interesting but generally on track. The AI will explore a bit.";
            else if (temp >= 0.4) varianceDesc = "<span class='section-emoji'>üßê</span>Low: Expect very similar and predictable responses. Good for strict consistency, but little surprise. The AI prefers familiar paths.";
            else varianceDesc = "<span class='section-emoji'>üßä</span>Extremely Low: Responses will be almost identical and highly deterministic. Minimal to no variation. Can feel robotic or stuck. <span class='positive-spin'>Useful for very specific, controlled outputs if it doesn't get stuck, or for a very stoic character.</span>";
            varianceText.innerHTML = varianceDesc;
            

            let coherenceDesc = ""; 
            coherenceText.parentElement.setAttribute('data-tooltip-text', "Coherence & Focus describe how logical, on-topic, and sensible the AI's responses are. Primarily influenced by Temperature and Min P; extreme Repetition Penalty can also negatively impact it.");
            if (minP > 0.5) coherenceDesc = "<span class='section-emoji'>üö´</span>Critically Low: Min P is so high it's likely filtering out almost all words, leading to broken, nonsensical, or no responses at all.";
            else if (temp > 1.5 && minP < 0.03) coherenceDesc = "<span class='section-emoji'>ü§™</span>Very Low: Extreme creativity and virtually no filter mean a high chance of nonsensical, random, or completely off-topic outputs. Expect chaos!";
            else if (temp > 1.2 && minP < 0.05) coherenceDesc = "<span class='section-emoji'>ü§Ø</span>Lower: With high creativity and a very loose filter, responses might often drift, become illogical, or lose the plot more easily. Can be fun for randomness.";
            else if (temp < 0.4 && minP < 0.03) coherenceDesc = "<span class='section-emoji'>üß±</span>Rigidly Focused & Potentially Stuck: While technically coherent on its narrow path, it may get stuck in loops or produce overly simplistic, repetitive text. Can be very dull.";
            else if (temp < 0.5 && minP > 0.15) coherenceDesc = "<span class='section-emoji'>üöß</span>Artificially Constrained: May seem coherent but could be very short or fail due to extreme filtering. Output might feel 'strangled'.";
            else if (temp < 0.7 && minP > 0.1) coherenceDesc = "<span class='section-emoji'>üéØ</span>Very High: Responses should be very logical, focused, and directly relevant. Unlikely to go off-topic.";
            else if (minP > 0.2 && temp > 1.2) coherenceDesc = "<span class='section-emoji'>‚ÅâÔ∏è</span>Potentially Conflicting: High creativity clashes with strict filtering, which may produce sparse, odd, or short results.";
            else coherenceDesc = "<span class='section-emoji'>‚úÖ</span>Good: Generally sensible and stays on topic. Reliable for storytelling and consistent character interactions.";
            if (repPen > 1.6 && !(temp > 1.2 && minP < 0.05) ) { 
                 coherenceDesc += " (Note: Very high Repetition Penalty can also make responses feel less natural or coherent due to forced word choices.)"
            }
            coherenceText.innerHTML = coherenceDesc;
            

            let adherenceDesc = ""; 
            adherenceText.parentElement.setAttribute('data-tooltip-text', "Prompt Adherence describes how closely the AI is expected to follow your specific prompts, instructions, and character concepts. Lower Temperature and moderate-to-high Min P generally increase adherence, but extreme Repetition Penalty can interfere.");
            if (temp < 0.4 && minP < 0.03) adherenceDesc = "<span class='section-emoji'>‚õìÔ∏è</span>Literal & Potentially Unresponsive: AI will attempt to adhere but may only grasp the most basic interpretation and get stuck.";
            else if (temp < 0.5 && minP > 0.1) adherenceDesc = "<span class='section-emoji'>ü§ñ</span>Extremely Strong: The AI will be rigidly bound to your prompt and character. Almost no creative deviation. Very robotic.";
            else if (temp < 0.7 && minP > 0.08) adherenceDesc = "<span class='section-emoji'>üëç</span>Very Strong: The AI will stick closely to your instructions and character details. Little deviation.";
            else if (temp <= 1.0 && minP >= 0.05) adherenceDesc = "<span class='section-emoji'>üëå</span>Strong: Follows instructions well, with minor creative interpretations fitting the context.";
            else if (temp > 1.6 || minP < 0.02) adherenceDesc = "<span class='section-emoji'>üé¢</span>Extremely Loose: The AI will likely disregard large parts of your prompt, following its own highly random path. <span class='positive-spin'>Can lead to completely unexpected scenarios!</span>";
            else if (temp > 1.2 || minP < 0.04) adherenceDesc = "<span class='section-emoji'>üå¨Ô∏è</span>Loose: Expect free interpretation of your prompt. The AI may deviate significantly. <span class='positive-spin'>Good for letting the AI take the lead.</span>";
            else adherenceDesc = "<span class='section-emoji'>ü§ù</span>Balanced: Follows your lead but adds its own creative touches to enhance the roleplay.";
            if (repPen > 1.7) adherenceDesc += " (Note: Extreme Repetition Penalty might make it hard for the AI to use specific keywords if your prompt requires them to be repeated.)";
            adherenceText.innerHTML = adherenceDesc;
            
            
            let repDesc = ""; 
            repetitionText.parentElement.setAttribute('data-tooltip-text', "Word Choice & Tone are primarily affected by Repetition Penalty, which influences how often the AI reuses words and phrases. This impacts the naturalness and variety of its dialogue.");
            if (repPen === 1.0) repDesc = "<span class='section-emoji'>üí¨</span>Neutral: Allows natural repetition. Words/phrases might repeat if common or contextually fitting.";
            else if (repPen <= 1.4) repDesc = "<span class='section-emoji'>üçÉ</span>Reduced: Gently discourages obvious repetition, making dialogue feel fresher and more varied.";
            else if (repPen <= 1.7) repDesc = "<span class='section-emoji'>‚úçÔ∏è</span>Strongly Reduced: Actively avoids repeating words, pushing for more unique vocabulary. <span class='positive-spin'>Can result in more eloquent or distinct character voices.</span>";
            else repDesc = `<span class='section-emoji'>üö´</span>Extremely Reduced: Forces highly unique phrasing. Language might become unnatural or use rare words to avoid any repetition.`;
            repetitionText.innerHTML = repDesc;
            
        }
        
        // --- Custom Tooltip Logic ---
        document.body.addEventListener('click', function(event) {
            let target = event.target;
            let tooltipText = null;

            // Check if the clicked element or its parent (for profile sections) has a data-tooltip-text
            if (target.hasAttribute('data-tooltip-text')) {
                tooltipText = target.getAttribute('data-tooltip-text');
            } else if (target.parentElement && target.parentElement.hasAttribute('data-tooltip-text')) {
                target = target.parentElement; // Tooltip is on the parent
                tooltipText = target.getAttribute('data-tooltip-text');
            } else if (target.classList.contains('trait-tag') && target.hasAttribute('data-tooltip')) {
                 tooltipText = target.getAttribute('data-tooltip');
            }


            if (tooltipText) {
                customTooltip.innerHTML = tooltipText;
                customTooltip.classList.remove('hidden');

                const targetRect = target.getBoundingClientRect();
                const tooltipRect = customTooltip.getBoundingClientRect();
                
                let top = targetRect.top - tooltipRect.height - 10; // Position above by default
                let left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);

                // Adjust if going off-screen
                if (top < 0) { // If too high, position below
                    top = targetRect.bottom + 10;
                }
                if (left < 0) left = 5; // Prevent left overflow
                if (left + tooltipRect.width > window.innerWidth) left = window.innerWidth - tooltipRect.width - 5; // Prevent right overflow
                
                customTooltip.style.top = `${top + window.scrollY}px`;
                customTooltip.style.left = `${left + window.scrollX}px`;
                
                event.stopPropagation(); // Prevent click from immediately hiding if it's also on body
            } else {
                // Hide tooltip if clicking anywhere else that's not a tooltip trigger
                if (!customTooltip.contains(event.target) && !event.target.hasAttribute('data-tooltip-text') && !(event.target.parentElement && event.target.parentElement.hasAttribute('data-tooltip-text')) && !event.target.classList.contains('trait-tag')) {
                    customTooltip.classList.add('hidden');
                }
            }
        });


        document.addEventListener('DOMContentLoaded', (event) => {
            const guideContentElement = document.getElementById('tips-guide-content'); 
            const markdownTemplate = document.getElementById('markdown-template'); 
            
            if (guideContentElement && markdownTemplate && typeof marked !== 'undefined') { 
                let markdownContent = markdownTemplate.textContent;
                let mainGuideHtml = marked.parse(markdownContent.split('<div id="troubleshooting-section-anchor"></div>')[0]);
                let afterAnchorHtmlParts = markdownContent.split('<div id="troubleshooting-section-anchor"></div>');
                let afterAnchorHtml = "";
                if (afterAnchorHtmlParts.length > 1) {
                    afterAnchorHtml = marked.parse(afterAnchorHtmlParts[1]); 
                }

                const troubleshootingTableHTML = `
                    <div id="troubleshooting-section-anchor"></div>
                    <h2>Common Issues & Troubleshooting Tips</h2>
                    <p>Here are some common scenarios and simplified fixes. The "Kyle's DreamJourney Tweaker" tool helps visualize these interactions.</p>
                    <table class="troubleshooting-table">
                        <thead>
                            <tr>
                                <th>Problem</th>
                                <th>Primary Suspect(s)</th>
                                <th>Quick Fixes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>AI is too repetitive or looping.</strong></td>
                                <td>Repetition Penalty too low (especially 1.0).</td>
                                <td><ul><li>Gradually increase <strong>Repetition Penalty</strong>.</li><li>If Temp is very low (<0.5), also slightly increase <strong>Temperature</strong>.</li></ul></td>
                            </tr>
                            <tr>
                                <td><strong>AI is talking nonsense/gibberish, or very off-topic.</strong></td>
                                <td>Temperature too high, AND/OR Min P too low.</td>
                                <td><ul><li>Slightly decrease <strong>Temperature</strong>.</li><li>If still an issue, slightly increase <strong>Min P</strong>.</li><li>Avoid extreme Temp with very low Min P for coherence.</li></ul></td>
                            </tr>
                            <tr>
                                <td><strong>AI is too boring/predictable, lacks creativity.</strong></td>
                                <td>Temperature too low, AND/OR Min P too high.</td>
                                <td><ul><li>Gradually increase <strong>Temperature</strong>.</li><li>If Temp is moderate, try slightly decreasing <strong>Min P</strong>.</li><li>Ensure Repetition Penalty isn't too high.</li></ul></td>
                            </tr>
                            <tr>
                                <td><strong>AI isn't following prompt well / poor adherence.</strong></td>
                                <td>Temperature too high, OR Min P too low.</td>
                                <td><ul><li>Decrease <strong>Temperature</strong>.</li><li>Slightly increase <strong>Min P</strong>.</li><li>If Rep Pen is very high and prompt needs repeated keywords, consider lowering Rep Pen.</li></ul></td>
                            </tr>
                            <tr>
                                <td><strong>AI responses are too short / stops mid-thought.</strong></td>
                                <td>Min P too high, OR very low Temp + high Min P.</td>
                                <td><ul><li>Significantly decrease <strong>Min P</strong>.</li><li>If Temp is very low, also increase <strong>Temperature</strong> a bit.</li><li>Check if Rep Pen is extremely high.</li></ul></td>
                            </tr>
                            <tr>
                                <td><strong>AI's language feels forced, unnatural, or uses weird words.</strong></td>
                                <td>Repetition Penalty is too high.</td>
                                <td><ul><li>Decrease <strong>Repetition Penalty</strong> towards recommended range.</li></ul></td>
                            </tr>
                        </tbody>
                    </table>
                    ${afterAnchorHtml} 
                `; 
                guideContentElement.innerHTML = mainGuideHtml + troubleshootingTableHTML;

            } else if (guideContentElement && markdownTemplate) {
                guideContentElement.innerHTML = '<h2>Tips & Troubleshooting Guide (Raw Markdown - Marked.js failed to load)</h2><pre>' + markdownTemplate.textContent + '</pre>';
                console.error("Marked.js library FAILED to load. Displaying raw Markdown for guide.");
            }
            
            // Theme Toggle
            if(themeToggleButton) {
                 themeToggleButton.addEventListener('click', () => {
                    document.body.classList.toggle('light-theme');
                    const isLight = document.body.classList.contains('light-theme');
                    localStorage.setItem('theme', isLight ? 'light' : 'dark');
                    themeToggleButton.textContent = isLight ? "Switch to Dark Theme üåô" : "Switch to Light Theme ‚òÄÔ∏è";
                });
                // Apply saved theme on load
                if (localStorage.getItem('theme') === 'light') {
                    document.body.classList.add('light-theme');
                    themeToggleButton.textContent = "Switch to Dark Theme üåô";
                } else {
                     themeToggleButton.textContent = "Switch to Light Theme ‚òÄÔ∏è";
                }
            }


            if(toggleGuideButton) {
                toggleGuideButton.addEventListener('click', () => {
                    if(guideContainerDiv) {
                        const isHidden = guideContainerDiv.classList.toggle('hidden');
                        toggleGuideButton.textContent = isHidden ? "AI Troubles? Show Guide" : "Hide Guide";
                        if (jumpToTroubleshootingButton) {
                            jumpToTroubleshootingButton.style.display = isHidden ? 'none' : 'block';
                        }
                        // Scroll to guide if showing
                        if (!isHidden && guideContainerDiv) { // ensure guideContainerDiv exists
                             setTimeout(() => { // Timeout to ensure element is visible before scrolling
                                guideContainerDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 0);
                        }
                    }
                });
            }

             if (jumpToTroubleshootingButton) {
                jumpToTroubleshootingButton.addEventListener('click', () => {
                    const troubleshootingAnchor = document.getElementById('troubleshooting-section-anchor');
                    if (guideContainerDiv && guideContainerDiv.classList.contains('hidden')) { 
                        guideContainerDiv.classList.remove('hidden');
                        if(toggleGuideButton) toggleGuideButton.textContent = "Hide Guide";
                        jumpToTroubleshootingButton.style.display = 'block';
                        setTimeout(() => { 
                            if (troubleshootingAnchor) {
                                troubleshootingAnchor.scrollIntoView({ behavior: 'smooth' });
                            }
                        }, 100); 
                    } else if (troubleshootingAnchor) {
                         troubleshootingAnchor.scrollIntoView({ behavior: 'smooth' });
                    }
                });
                 if (guideContainerDiv && guideContainerDiv.classList.contains('hidden')) {
                    jumpToTroubleshootingButton.style.display = 'none';
                } else if (guideContainerDiv) { 
                     jumpToTroubleshootingButton.style.display = 'block';
                 }
            }
            applyDefaults(); 
        });

        tempSlider.addEventListener('input', updateUI);
        minPSlider.addEventListener('input', updateUI);
        repPenSlider.addEventListener('input', updateUI);
        resetButton.addEventListener('click', applyDefaults);
        
    </script>
</body>
</html>
